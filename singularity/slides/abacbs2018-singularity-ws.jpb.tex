%-------------------------------------------------------------------------------
%  \author Jan P Buchmann <jan.buchmann@sydney.edu.au>
%  \copyright 2018 The University of Sydney
%  \description
%-------------------------------------------------------------------------------

\documentclass{beamer}
\usetheme{default}
\usepackage{inconsolata}
\hypersetup{pdfstartview={Fit}}
\beamertemplatenavigationsymbolsempty
\setbeamertemplate{footline}[frame number]
\usepackage{xspace}
\usepackage{booktabs}
\usepackage{hyperref}
\usepackage{graphics}
\usepackage{listings}
\usepackage{jpb.lst}
\usepackage{multirow}
\usepackage{tikz}

\newcommand{\compresslist}{
  \setlength{\itemsep}{1pt}
  \setlength{\parskip}{0pt}
  \setlength{\parsep}{0pt}
}

%%% Titleslide  %%%
\title[]{Introdution to Singularity containers}
\subtitle{}
\author[]{Jan P. Buchmann\\\small{\href{mailto:jan.buchmann@sydney.edu.au}{jan.buchmann@sydney.edu.au}}}
\institute{The University Of Sydney}
\date{2018-11-29}
%**************************
\begin{document}
  \titlepage

  \begin{frame}{Just in case...}
    \small
    \begin{description}
      \item[Download] \url{https://www.sylabs.io/singularity/get-singularity/}
      \item[Manual] \url{https://www.sylabs.io/guides/3.0/user-guide.pdf}
      \item[Paper] \url{https://www.sylabs.io/guides/3.0/user-guide.pdf}
    \end{description}
  \end{frame}

  \begin{frame}{Singularity: Containers for HPC}
   Containers are encapsulated system enviroments
    \begin{description}
      \item[Not a microservice:] Scientific focus, e.g. whole pipelines
      \item[Single file:] The image is a single file easily share, archive,
                          reproduce, good for parallel file sytems, e.g. Lustre
      \item[Run as user:] root to create, user to run
      \item[Access HPC resources:] MPI, GPUs, InfiniBand/Network, file systems
    \end{description}
  \end{frame}

  \begin{frame}{Biggest difference to Docker}
    \small
    \begin{block}{Privileges}
      You run the container as the user who invokes singularity. You can only
      be root in the container if you run it as root. Not your usual HPC
      experience.
    \end{block}
    \begin{block}{No daemon}
      There is no deamon required, Singularity image is mounted as a loopback.
      Docker swarms need a DockerEngine on each  node or instance they run.
    \end{block}
    \begin{block}{Runs closer to the host}
      Running a singularity container bind mount your \$HOME, /dev, /sys, and
      /proc automatically by default.
    \end{block}
    \begin{block}{Singularity Image Format (SIF) ($\geq$3.0)}
      Image container format resembling a general file system whoch will allow
      PGP signing, block encryption, partitions accomodating multiple OSes,
      fast metadata access.
    \end{block}
    \begin{block}{Docker layers change}
      Docker image layers can change, i.e. a docker image has likely changed
      layers when pulled a couple of months later.
    \end{block}
  \end{frame}

  \begin{frame}{Speed}

  \end{frame}

  \begin{frame}{Overall singularity workflow}
    \input{figs/singularity-workflow-overall.fig.tex}
  \end{frame}

  \begin{frame}{Building singularity containers}
    \begin{description}
      \item[Docker Hub (docker://)] singularity build lolcow.simg docker://godlovedc/lolcow
      \item[Container Library (library://)] singularity build lolcow.simg library://sylabs-jms/testing/lolcow
      \item[Singularity Hub (shub://)] singularity build demo.simg shub://jasongallant/singularity\_demosingularity
      \item[Singularity receipe files] Roll your own
    \end{description}
  \end{frame}

  \begin{frame}{Invoking singularity}
    \footnotesize
    \texttt{singularity [global options] command [command options]}\\
    \texttt{singularity -v build --sandbox /tmp/ubuntu docker://ubuntu:latest}
  \end{frame}

  \begin{frame}{Workflow: Build enviroment (root)}
    \small
    \begin{block}{Interactive}
      \bashexternal{lsts/singularity-interactive.sh}
    \end{block}
  \end{frame}

  \begin{frame}{Workflow: Let's build a container..}
    \begin{verbatim}
      \end{verbatim}
    \begin{block}{Interactive}
      \bashexternal{lsts/singularity-interactive.sh}
      Example: \url{../commands/commands.md}
    \end{block}
  \end{frame}

  \begin{frame}{Workflow: Receipe file}
      \begin{itemize}
        \item Preferred way to crate images. Use interactive to get details
              right, test depencdencies, etc.  than fixeverything in a receipe
              file.
        \end{itemize}
      Example: \url{../receipes/raxml.ubuntu.def}
  \end{frame}

  \begin{frame}{Singularity on HPC}
    \begin{itemize}
      \item Host and container OS need same OpenMPI/MPI version
      \item Adjust image for binding directories
      \item Adjust GPU specific files, libraries
    \end{itemize}
    Example PBS file: \url{../receipes/raxml-sing.pbs}
  \end{frame}
\end{document}
